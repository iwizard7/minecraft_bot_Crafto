package com.crafto.ai.ai;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.crafto.ai.CraftoMod;
import com.crafto.ai.action.Task;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class ResponseParser {
    
    public static ParsedResponse parseAIResponse(String response) {
        if (response == null || response.isEmpty()) {
            return null;
        }

        try {
            CraftoMod.LOGGER.info("ResponseParser input: {}", response);
            String jsonString = extractJSON(response);
            CraftoMod.LOGGER.info("ResponseParser extracted JSON: {}", jsonString);

            JsonObject json = JsonParser.parseString(jsonString).getAsJsonObject();
            
            String reasoning = json.has("reasoning") ? json.get("reasoning").getAsString() : "";
            String plan = json.has("plan") ? json.get("plan").getAsString() : "";
            List<Task> tasks = new ArrayList<>();
            
            if (json.has("tasks") && json.get("tasks").isJsonArray()) {
                JsonArray tasksArray = json.getAsJsonArray("tasks");
                
                for (JsonElement taskElement : tasksArray) {
                    if (taskElement.isJsonObject()) {
                        JsonObject taskObj = taskElement.getAsJsonObject();
                        Task task = parseTask(taskObj);
                        if (task != null) {
                            tasks.add(task);
                        }
                    }
                }
            }
            
            // Filter out mining tasks for build commands to prevent complex plans
            if (hasBuildTask(tasks)) {
                tasks = filterOutMiningTasks(tasks);
            }

            if (!reasoning.isEmpty()) {            }

            return new ParsedResponse(reasoning, plan, tasks);
            
        } catch (Exception e) {
            CraftoMod.LOGGER.error("Failed to parse AI response: {}", response, e);
            return null;
        }
    }

    private static String extractJSON(String response) {
        String cleaned = response.trim();

        if (cleaned.startsWith("```json")) {
            cleaned = cleaned.substring(7);
        } else if (cleaned.startsWith("```")) {
            cleaned = cleaned.substring(3);
        }

        if (cleaned.endsWith("```")) {
            cleaned = cleaned.substring(0, cleaned.length() - 3);
        }

        cleaned = cleaned.trim();

        // Remove comments (// ... and /* ... */)
        cleaned = cleaned.replaceAll("//.*$", ""); // Remove single-line comments
        cleaned = cleaned.replaceAll("/\\*.*?\\*/", ""); // Remove multi-line comments

        // Fix common JSON formatting issues
        cleaned = cleaned.replaceAll("\\n\\s*", " ");

        // Fix missing commas between array/object elements (common AI mistake)
        cleaned = cleaned.replaceAll("}\\s+\\{", "},{");
        cleaned = cleaned.replaceAll("}\\s+\\[", "},[");
        cleaned = cleaned.replaceAll("]\\s+\\{", "],{");
        cleaned = cleaned.replaceAll("]\\s+\\[", "],[");
        cleaned = cleaned.replaceAll(",\\s*}", "}"); // Remove trailing commas
        cleaned = cleaned.replaceAll(",\\s*]", "]"); // Remove trailing commas

        return cleaned;
    }

    private static Task parseTask(JsonObject taskObj) {
        if (!taskObj.has("action")) {
            return null;
        }
        
        String action = taskObj.get("action").getAsString();
        Map<String, Object> parameters = new HashMap<>();
        
        if (taskObj.has("parameters") && taskObj.get("parameters").isJsonObject()) {
            JsonObject paramsObj = taskObj.getAsJsonObject("parameters");
            
            for (String key : paramsObj.keySet()) {
                JsonElement value = paramsObj.get(key);
                
                if (value.isJsonPrimitive()) {
                    if (value.getAsJsonPrimitive().isNumber()) {
                        parameters.put(key, value.getAsNumber());
                    } else if (value.getAsJsonPrimitive().isBoolean()) {
                        parameters.put(key, value.getAsBoolean());
                    } else {
                        parameters.put(key, value.getAsString());
                    }
                } else if (value.isJsonArray()) {
                    List<Object> list = new ArrayList<>();
                    for (JsonElement element : value.getAsJsonArray()) {
                        if (element.isJsonPrimitive()) {
                            if (element.getAsJsonPrimitive().isNumber()) {
                                list.add(element.getAsNumber());
                            } else {
                                list.add(element.getAsString());
                            }
                        }
                    }
                    parameters.put(key, list);
                }
            }
        }
        
        return new Task(action, parameters);
    }

    /**
     * Check if the task list contains any build actions
     */
    private static boolean hasBuildTask(List<Task> tasks) {
        return tasks.stream().anyMatch(task -> "build".equals(task.getAction()));
    }

    /**
     * Filter out non-build tasks from the task list when build tasks are present
     */
    private static List<Task> filterOutMiningTasks(List<Task> tasks) {
        List<Task> filteredTasks = new ArrayList<>();
        for (Task task : tasks) {
            String action = task.getAction();
            if ("build".equals(action)) {
                filteredTasks.add(task);
            } else {
                CraftoMod.LOGGER.info("Filtered out non-build task from build command: {}", task);
            }
        }
        return filteredTasks;
    }

    public static class ParsedResponse {
        private final String reasoning;
        private final String plan;
        private final List<Task> tasks;

        public ParsedResponse(String reasoning, String plan, List<Task> tasks) {
            this.reasoning = reasoning;
            this.plan = plan;
            this.tasks = tasks;
        }

        public String getReasoning() {
            return reasoning;
        }

        public String getPlan() {
            return plan;
        }

        public List<Task> getTasks() {
            return tasks;
        }
    }
}
